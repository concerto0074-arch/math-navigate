<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>æ•°æµ·å¼•èˆª Â· æ§åˆ¶å°(æ¥å…¥çœŸé¢˜å¢™)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- ç”»é£ï¼šæ”¹ä¸ºä¸æˆªå›¾ç›¸è¿‘çš„æµ…è‰²+æ‰‹å†™æ ‡é¢˜é£ -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  /* æµ…è‰²ä¸»é¢˜ï¼ˆæ¥è¿‘æˆªå›¾é£æ ¼ï¼‰ */
  --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --text:#111827; --pri:#3b82f6;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#e5e7eb; --chip:#eef2ff; --aside:#ffffff;
  --ink:#334155; --soft:#f1f5f9;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font:14px/1.6 "Noto Sans SC",-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
  background:linear-gradient(180deg,#f8fafc 0%,#f5f7fb 100%);color:var(--text)
}
a{color:inherit;text-decoration:none}
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
aside{
  background:var(--aside);border-right:1px solid var(--line);padding:14px;position:sticky;top:0;height:100vh;overflow:auto
}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;margin-bottom:10px}
.brand .mark{
  font-family:"ZCOOL KuaiLe",cursive; font-size:20px; letter-spacing:1px; color:#1f2937; display:flex; align-items:center; gap:8px
}
.brand .mark .seal{
  width:26px;height:26px;border-radius:6px;background:#2563eb;color:#fff;display:grid;place-items:center;font-weight:900;box-shadow:0 2px 6px rgba(37,99,235,.35)
}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.nav button{
  display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;color:var(--text);
  padding:10px 12px;border-radius:12px;cursor:pointer;text-align:left;box-shadow:0 1px 0 rgba(0,0,0,.02)
}
.nav .active{background:#e8f0fe;border-color:#c7d2fe}
.nav .muted{color:var(--muted)}
main{padding:18px}
.section{max-width:none;margin:18px 0 0 0}
.grid{display:grid;gap:12px}
.grid.auto-2{grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
.grid.auto-3{grid-template-columns:repeat(auto-fit,minmax(380px,1fr))}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 2px 6px rgba(15,23,42,.04)}
.flex{display:flex;align-items:center;gap:8px}
.right{margin-left:auto}
.muted{color:var(--muted)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{
  display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:7px 12px;border-radius:10px;background:#fff;color:var(--text);cursor:pointer
}
.btn.primary{background:var(--pri);border-color:transparent;color:#fff}
.chart{height:300px;width:100%;min-width:300px;background:var(--soft);border:1px dashed var(--line);border-radius:10px}
textarea,input,select{
  width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:9px
}
.kpi{font-size:28px;font-weight:800}
.chip{background:var(--chip);border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;font-size:12px;color:#1e3a8a}
.match{border:1px dashed var(--line);border-radius:10px;padding:10px;background:#fff}
.avatar{width:28px;height:28px;display:inline-grid;place-items:center;background:#dbeafe;border-radius:50%;font-size:12px;color:#1e3a8a;font-weight:700}
.nowrap{white-space:nowrap}
.toptools{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}
.dropdown{position:relative}
.dropdown-menu{
  position:absolute;right:0;top:calc(100% + 8px);min-width:260px;background:var(--card);
  border:1px solid var(--line);border-radius:12px;padding:8px;display:none;z-index:25;box-shadow:0 8px 24px rgba(0,0,0,.08)
}
.dropdown.open .dropdown-menu{display:block}
.notice{display:flex;gap:8px;padding:8px;border-radius:8px}
.notice:hover{background:#f8fafc}
.badge{background:var(--bad);color:#fff;border-radius:8px;padding:0 6px;font-size:12px}

.header{
  position:sticky;top:0;z-index:15;background:rgba(255,255,255,.8);backdrop-filter:blur(6px);
  border-bottom:1px solid var(--line);padding:10px 16px;display:flex;align-items:center;gap:12px
}
.header .title{
  margin:0 auto;font-family:"ZCOOL KuaiLe",cursive;font-size:22px;color:var(--ink);display:flex;align-items:center;gap:10px
}
.header .title small{font:12px/1 monospace;color:#475569;background:#e2e8f0;border-radius:6px;padding:2px 6px}

/* èŠå¤©æŠ½å±‰ï¼šæ”¹ä¸ºå¯é€‰è”ç³»äºº+ä¼šè¯åŒºï¼ŒçœŸæ­£å¯ç”¨(æœ¬åœ°æŒä¹…+å¤šæ ‡ç­¾åŒæ­¥) */
.drawer{
  position:fixed;right:-420px;top:0;height:100%;width:420px;background:var(--card);
  border-left:1px solid var(--line);transition:right .25s ease;z-index:30;display:flex;flex-direction:column;box-shadow:-6px 0 18px rgba(0,0,0,.08)
}
.drawer.open{right:0}
.chat-head{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
.chat-body{flex:1;overflow:auto;padding:12px;display:grid;grid-template-columns:140px 1fr;gap:8px}
.chat-list{border-right:1px solid var(--line);padding-right:8px;overflow:auto}
.chat-item{max-width:100%;padding:8px 10px;border-radius:10px}
.message{display:flex;flex-direction:column;gap:6px}
.msg{max-width:85%;padding:8px 10px;border-radius:10px}
.msg.me{align-self:flex-end;background:#dbeafe;color:#1e3a8a}
.msg.you{align-self:flex-start;background:#f1f5f9}
.chat-input{padding:12px;border-top:1px solid var(--line);display:flex;gap:8px}
.contact{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;cursor:pointer}
.contact.active,.contact:hover{background:#f8fafc}
.contact .ct-name{font-weight:700;color:#334155}
.requires-mask{position:relative}
.requires-mask::after{
  content:'éœ€å…ˆé…ç½® API';position:absolute;inset:0;background:rgba(0,0,0,.05);
  display:flex;align-items:center;justify-content:center;border-radius:12px;font-weight:700;color:#0f172a
}
.defense-score{font-size:20px;font-weight:700}
.score-excellent{color:#22c55e}
.score-good{color:#2563eb}
.score-fair{color:#f59e0b}
.score-poor{color:#ef4444}

/* çœŸé¢˜å¢™åµŒå…¥æ¨¡å—æ ·å¼ï¼ˆæˆªå›¾é£æ ¼ï¼‰ */
.zhen-header{
  display:flex;align-items:center;gap:12px;padding:8px 10px;background:#ffffff;border:1px solid var(--line);border-radius:12px
}
.zhen-header .logo{
  display:flex;align-items:center;gap:8px;font-family:"ZCOOL KuaiLe",cursive;color:#111827
}
.zhen-header .logo b{font-size:22px}
.zhen-iframe{
  width:100%;height:520px;border:1px solid var(--line);border-radius:12px;background:#fff
}
.hint{font-size:12px;color:var(--muted);margin-top:4px}
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
<!-- é¡¶éƒ¨æ ‡é¢˜æ¡ï¼ˆæ‰‹å†™é£ï¼‰ -->
<div class="header">
  <div class="title">
    <span style="background:#2563eb;color:#fff;border-radius:8px;padding:2px 8px">çœŸé¢˜å¢™</span>
    <span>æ•°æµ·å¼•èˆª</span>
    <small>zhentiqiang.com</small>
  </div>
  <div class="right"></div>
</div>

<!-- ç™»å½•/æ³¨å†Œ -->
<div id="auth" class="auth" aria-modal="true" role="dialog" style="position:fixed;inset:0;background:linear-gradient(180deg,#ffffff,transparent),rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50">
  <div class="panel" style="background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;width:min(520px,92vw);box-shadow:0 12px 36px rgba(0,0,0,.12)">
    <div class="flex" style="justify-content:space-between">
      <b style="font-size:18px">æ•°æµ·å¼•èˆª Â· è´¦æˆ·</b>
      <span class="muted">æ¼”ç¤ºç¯å¢ƒ(æœ¬åœ°å­˜å‚¨)</span>
    </div>
    <div class="tabs" style="display:flex;gap:8px;margin:12px 0">
      <button id="tabLogin" class="active" onclick="AuthUI.switchTab('login')" style="flex:1;border-radius:12px;border:1px solid var(--line);background:#e8f0fe;padding:10px;color:#1e3a8a;cursor:pointer">ç™»å½•</button>
      <button id="tabRegister" onclick="AuthUI.switchTab('register')" style="flex:1;border-radius:12px;border:1px solid var(--line);background:#fff;padding:10px;cursor:pointer">æ³¨å†Œ</button>
    </div>
    <div id="loginForm">
      <label>é‚®ç®±</label>
      <input id="loginUser" placeholder="demo@example.com"/>
      <label style="margin-top:8px">å¯†ç </label>
      <input id="loginPass" type="password" placeholder="è‡³å°‘ 6 ä½"/>
      <label style="margin-top:8px">API Key(å¯é€‰)</label>
      <input id="loginAPI" placeholder="ä¾‹å¦‚:sk-xxxx(ç™»å½•æ—¶ç›´æ¥ç”Ÿæ•ˆ)"/>
      <div class="flex" style="justify-content:space-between;margin-top:10px">
        <div class="flex" style="gap:6px"><input id="remember" type="checkbox"/><label for="remember" class="muted">è®°ä½ç™»å½•</label></div>
        <button class="btn primary" onclick="authLogin()">ç™»å½•</button>
      </div>
      <div class="hint">æ¼”ç¤ºè´¦å·: demo@example.com / 123456</div>
    </div>
    <div id="registerForm" class="collapse" style="display:none">
      <label>æ˜µç§°</label>
      <input id="regName" placeholder="ä½ çš„æ˜µç§°"/>
      <label style="margin-top:8px">é‚®ç®±</label>
      <input id="regMail" placeholder="you@example.com"/>
      <label style="margin-top:8px">å¯†ç </label>
      <input id="regPass" type="password" placeholder="è‡³å°‘ 6 ä½,åŒ…å«å­—æ¯ä¸æ•°å­—"/>
      <label style="margin-top:8px">API Key(é€‰å¡«)</label>
      <input id="regAPI" placeholder="ä¾‹å¦‚:sk-xxxx(ç”¨äºä¾èµ–æ¥å£çš„åŠŸèƒ½)"/>
      <div class="flex" style="justify-content:flex-end;margin-top:10px">
        <button class="btn primary" onclick="authRegister()">æ³¨å†Œ</button>
      </div>
      <div class="hint">ä¸å¡«ä¹Ÿå¯æ³¨å†Œ;ä½†éƒ¨åˆ†åŠŸèƒ½å°†è¢«ç¦ç”¨,å¾…è®¾ç½® API åå¯ç”¨ã€‚</div>
    </div>
  </div>
</div>

<!-- åº”ç”¨ -->
<div class="app" id="app" style="visibility:hidden">
  <aside>
    <div class="brand">
      <div class="mark"><span class="seal">é¢˜</span><b>æ•°æµ·å¼•èˆª Â· æ§åˆ¶å°</b></div>
    </div>
    <div class="nav" id="nav">
      <button class="active" data-go="overview" onclick="go('overview',this)">ä»ªè¡¨ç›˜</button>
      <button data-go="matching" onclick="go('matching',this)">æ™ºèƒ½ç»„é˜Ÿ</button>
      <button data-go="review" onclick="go('review',this)">ä»£ç å®¡æŸ¥</button>
      <button data-go="paper" onclick="go('paper',this)">è®ºæ–‡åŠ©æ‰‹</button>
      <button data-go="rag" onclick="go('rag',this)">èµ›é¢˜è§£æ</button>
      <button data-go="simulate" onclick="go('simulate',this)">çœŸé¢˜ç»ƒä¹ </button>
      <button data-go="community" onclick="go('community',this)">ç¤¾åŒº</button>
      <button data-go="market" onclick="go('market',this)">å¸‚åœº&è´¢åŠ¡</button>
      <button data-go="settings" onclick="openAPIModal()">API è®¾ç½®</button>
      <div class="muted" style="margin-top:6px;font-size:12px">å·²ç™»å½•:<span id="who"></span></div>
      <button class="btn" style="margin-top:8px" onclick="logout()">é€€å‡º</button>
    </div>
  </aside>
  <main>
    <div class="toptools">
      <div class="dropdown" id="notifyDrop">
        <button class="btn" onclick="UI.toggleDropdown('notifyDrop')">ğŸ”” é€šçŸ¥ <span class="badge" id="notifyCount">3</span></button>
        <div class="dropdown-menu">
          <div class="notice"><span class="avatar">A</span><div><div>ç®—æ³•èµ›é˜Ÿå‹ <b>å¼ æ€æº</b> ç”³è¯·åŠ å…¥</div><div class="muted" style="font-size:12px">2 åˆ†é’Ÿå‰</div></div></div>
          <div class="notice"><span class="avatar">S</span><div><div>ã€Œä»£ç å®¡æŸ¥ã€å‘ç° 1 ä¸ªæ€§èƒ½æ”¹è¿›å»ºè®®</div><div class="muted" style="font-size:12px">7 åˆ†é’Ÿå‰</div></div></div>
          <div class="notice"><span class="avatar">C</span><div><div>ç¤¾åŒºé—®é¢˜è·å¾— 2 ä¸ªæ–°å›å¤</div><div class="muted" style="font-size:12px">12 åˆ†é’Ÿå‰</div></div></div>
        </div>
      </div>
      <button class="btn" onclick="UI.toggleChat()">ğŸ’¬ èŠå¤©</button>
    </div>

    <!-- æ¦‚è§ˆ -->
    <section id="overview" class="section">
      <div class="grid auto-2">
        <div class="card">
          <div class="flex"><h3>å¢é•¿æ›²çº¿</h3><span class="muted">æ¼”ç¤ºæ•°æ®</span></div>
          <div id="chart-growth" class="chart" data-chart="growth"></div>
          <div class="right toolbar"><button class="btn" onclick="ChartManager.exportPNG('chart-growth')">å¯¼å‡ºPNG</button></div>
        </div>
        <div class="card">
          <div class="flex"><h3>åŠŸèƒ½ä½¿ç”¨å æ¯”</h3><span class="muted">è¿‘30å¤©</span></div>
          <div id="chart-usage" class="chart" data-chart="usage"></div>
          <div class="right toolbar"><button class="btn" onclick="ChartManager.exportPNG('chart-usage')">å¯¼å‡ºPNG</button></div>
        </div>
      </div>
    </section>

    <!-- æ™ºèƒ½ç»„é˜Ÿ -->
    <section id="matching" class="section" style="display:none">
      <div class="grid auto-2">
        <div class="card">
          <h3>æˆ‘çš„èƒ½åŠ›é›·è¾¾(å…­ç»´)</h3>
          <div id="chart-radar" class="chart" data-chart="radar"></div>
          <div class="grid auto-3">
            <div><label>ç®—æ³•</label><input type="range" min="0" max="100" value="70" class="skill" data-i="0"></div>
            <div><label>ç¼–ç¨‹</label><input type="range" min="0" max="100" value="75" class="skill" data-i="1"></div>
            <div><label>æ•°æ®</label><input type="range" min="0" max="100" value="60" class="skill" data-i="2"></div>
            <div><label>å†™ä½œ</label><input type="range" min="0" max="100" value="55" class="skill" data-i="3"></div>
            <div><label>å»ºæ¨¡</label><input type="range" min="0" max="100" value="65" class="skill" data-i="4"></div>
            <div><label>å¯è§†</label><input type="range" min="0" max="100" value="50" class="skill" data-i="5"></div>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="matchTeammates()">å¼€å§‹åŒ¹é…</button>
            <span class="muted">ç®—æ³•:ä½™å¼¦ç›¸ä¼¼ + äº’è¡¥åº¦(å†™ä½œ/å¯è§†åŒ–æƒé‡â†‘)</span>
          </div>
        </div>
        <div class="card">
          <div class="flex"><h3>æ¨èé˜Ÿå‹(Top 6)</h3><span class="muted">(æ”¯æŒä¸€é”®ç§èŠ)</span></div>
          <div id="matchList" class="grid auto-2"></div>
        </div>
      </div>
    </section>

    <!-- ä»£ç å®¡æŸ¥(ä¾èµ– API) -->
    <section id="review" class="section" style="display:none" data-requires-api="true">
      <div class="grid auto-2">
        <div class="card">
          <div class="flex">
            <h3>ä»£ç å®¡æŸ¥åŠ©æ‰‹</h3>
            <select id="lang" style="width:auto;margin-left:auto;">
              <option>Python</option><option>Java</option>
            </select>
          </div>
          <textarea id="code" rows="14" placeholder="# ç²˜è´´ä½ çš„ä»£ç ,ç‚¹å‡»è¿è¡Œå®¡æŸ¥

def two_sum(nums, target):
    for i in range(len(nums)):
        for j in range(i+1, len(nums)): # O(n^2)
            if nums[i] + nums[j] == target:
                return [i, j]
    return []"></textarea>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="runReview()">è¿è¡Œå®¡æŸ¥</button>
            <button class="btn" onclick="insertSnippet()">æ’å…¥ç¤ºä¾‹</button>
          </div>
        </div>
        <div class="card">
          <h3>å®¡æŸ¥ç»“æœä¸ä¿®å¤å»ºè®®</h3>
          <div id="reviewOut"></div>
        </div>
      </div>
    </section>

    <!-- è®ºæ–‡åŠ©æ‰‹(å¯ç”¨:ç¦»çº¿éª¨æ¶ä¸ LaTeX;AI æ®µè½ä¸ºå¯é€‰é¡¹) -->
    <section id="paper" class="section" style="display:none">
      <div class="grid auto-2">
        <div class="card">
          <h3>è®ºæ–‡éª¨æ¶ä¸ LaTeX æ¨¡æ¿</h3>
          <div class="grid auto-3">
            <div><label>èµ›äº‹ç±»å‹</label>
              <select id="contest">
                <option value="mcm">æ•°å­¦å»ºæ¨¡</option>
                <option value="bigdata">å¤§æ•°æ®</option>
                <option value="algo">ç®—æ³•è®¾è®¡</option>
              </select>
            </div>
            <div><label>æ¨¡æ¿</label>
              <select id="tpl">
                <option value="ieee">IEEE</option>
                <option value="acm">ACM</option>
                <option value="generic">æœŸåˆŠé€šç”¨</option>
              </select>
            </div>
            <div><label>è¯­è¨€</label>
              <select id="lang2">
                <option value="cn">ä¸­æ–‡</option>
                <option value="en">English</option>
              </select>
            </div>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="genPaper()">ç”Ÿæˆéª¨æ¶ä¸ LaTeX</button>
            <button class="btn" onclick="downloadTex()">å¯¼å‡º .tex</button>
            <span class="muted">ç¦»çº¿å¯ç”¨;å¯ç›´æ¥ç”Ÿæˆå¯ç¼–è¯‘æ¨¡æ¿ã€‚</span>
          </div>
          <pre id="paperOut" style="white-space:pre-wrap;background:#fff;border:1px solid var(--line);border-radius:8px;padding:10px;margin-top:8px;min-height:160px">é€‰æ‹©å‚æ•°åç‚¹å‡»"ç”Ÿæˆ"ã€‚</pre>
          <div class="toolbar" style="margin-top:8px">
            <input id="paperTitle" placeholder="å¯é€‰:è®ºæ–‡æ ‡é¢˜(ç”¨äº LaTeX)"/>
            <input id="paperAuthors" placeholder="å¯é€‰:ä½œè€…(é€—å·åˆ†éš”)"/>
          </div>
        </div>
        <div class="card" data-requires-api="true">
          <h3>AI æ®µè½ç”Ÿæˆ(å¯é€‰)</h3>
          <div class="grid auto-3">
            <div>
              <label>ç« èŠ‚</label>
              <select id="secPick">
                <option value="abstract">æ‘˜è¦</option>
                <option value="intro">å¼•è¨€</option>
                <option value="method">æ–¹æ³•</option>
                <option value="experiment">å®éªŒ</option>
                <option value="conclusion">ç»“è®º</option>
              </select>
            </div>
            <div>
              <label>å…³é”®è¯</label>
              <input id="secKW" placeholder="é€—å·åˆ†éš”,å¦‚: è¦†ç›–,å®¹é‡,é¢„ç®—"/>
            </div>
            <div>
              <label>ç›®æ ‡è¯»è€…</label>
              <select id="aud">
                <option value="reviewer">è¯„å®¡</option>
                <option value="student">å­¦ç”Ÿ</option>
                <option value="industry">äº§ä¸š</option>
              </select>
            </div>
          </div>
          <textarea id="secCtx" rows="6" placeholder="å¯é€‰:ç»™å‡ºæ•°æ®é›†ã€æŒ‡æ ‡ä¸æ–¹æ³•è¦ç‚¹(å°†èåˆåˆ°æ®µè½ä¸­)"></textarea>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="genSection()">ç”Ÿæˆæ®µè½</button>
            <span class="muted">æœªé…ç½® API æ—¶å°†æç¤ºé…ç½®;é…ç½®åå¯ç”¨(æ¼”ç¤ºç”Ÿæˆ)ã€‚</span>
          </div>
          <pre id="secOut" style="white-space:pre-wrap;background:#fff;border:1px solid var(--line);border-radius:8px;padding:10px;margin-top:8px;min-height:120px">ç”¨äºè‰æ‹ŸæŸä¸€ç« èŠ‚çš„æ®µè½ã€‚</pre>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>ç« èŠ‚è§„åˆ’</h3>
        <div class="grid auto-3">
          <span class="chip">æ‘˜è¦</span><span class="chip">å¼•è¨€</span><span class="chip">ç›¸å…³å·¥ä½œ</span>
          <span class="chip">æ–¹æ³•</span><span class="chip">å®éªŒ</span><span class="chip">ç»“è®º</span>
        </div>
      </div>
    </section>

    <!-- èµ›é¢˜è§£æ -->
    <section id="rag" class="section" style="display:none">
      <div class="grid auto-2">
        <div class="card">
          <h3>èµ›é¢˜è§£æ Â· è¾“å…¥</h3>
          <textarea id="ragInput" rows="10" placeholder="ç²˜è´´èµ›é¢˜æè¿°ã€çº¦æŸã€æŒ‡æ ‡ç­‰..."></textarea>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="analyzeRAG()">ç”Ÿæˆè¦ç‚¹ä¸ç»“æ„</button>
            <span class="muted">æå–å®ä½“/çº¦æŸ/ç›®æ ‡,ç»˜åˆ¶è¾“å…¥ç»“æ„å›¾</span>
          </div>
          <div id="ragOut" class="muted" style="margin-top:8px">ç­‰å¾…è¾“å…¥...</div>
        </div>
        <div class="card">
          <div class="flex"><h3>è¾“å…¥ç»“æ„</h3><span class="muted">Sankey(æ¼”ç¤º)</span></div>
          <div id="c-input-structure" class="chart" data-chart="inputstruct"></div>
          <div class="right toolbar"><button class="btn" onclick="ChartManager.exportPNG('c-input-structure')">å¯¼å‡ºPNG</button></div>
        </div>
      </div>
    </section>

    <!-- çœŸé¢˜ç»ƒä¹ ï¼šç”¨çœŸé¢˜å¢™æ›¿æ¢åŸâ€œå†å¹´çœŸé¢˜å›æº¯â€å°æ¨¡å—ï¼Œä¿æŒå…¶ä»–ä¸å˜ -->
    <section id="simulate" class="section" style="display:none">
      <div class="grid auto-2">
        <!-- çœŸé¢˜å¢™åµŒå…¥ -->
        <div class="card">
          <div class="zhen-header">
            <div class="logo"><span class="avatar" style="background:#1e293b;color:#fff">å¢™</span><b>çœŸé¢˜å¢™</b><span class="muted">zhentiqiang.com</span></div>
            <div class="right toolbar">
              <label class="muted nowrap">æ¨¡å¼</label>
              <select id="zhenMode" style="width:auto">
                <option value="home">é¦–é¡µ(å…¨éƒ¨)</option>
                <option value="math">è€ƒç ”æ•°å­¦</option>
                <option value="english">è‹±è¯­</option>
                <option value="cs">è®¡ç®—æœº/ç®—æ³•</option>
              </select>
              <button class="btn" onclick="openZhentiInNew()">æ–°æ ‡ç­¾æ‰“å¼€</button>
            </div>
          </div>
          <iframe id="zhenFrame" class="zhen-iframe" src="https://zhentiqiang.com/" referrerpolicy="no-referrer" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
          <div class="hint">è¯´æ˜: è¯¥ç«™å¯èƒ½é™åˆ¶ iframe åŠ è½½ï¼›è‹¥æ˜¾ç¤ºå—é™ï¼Œè¯·ç‚¹å‡»â€œæ–°æ ‡ç­¾æ‰“å¼€â€ã€‚</div>
        </div>

        <!-- å€’è®¡æ—¶ä¸å‹åŠ›æµ‹è¯•ï¼ˆåŸæ ·ä¿ç•™ï¼‰ -->
        <div class="card">
          <h3>å€’è®¡æ—¶ä¸å‹åŠ›æµ‹è¯•</h3>
          <div class="grid auto-2" style="margin-bottom:10px">
            <div>
              <label>è®¾ç½®æ—¶é—´(å°æ—¶)</label>
              <input type="number" id="timeInput" min="1" max="24" value="8" style="width:100%"/>
            </div>
            <div>
              <label>å‹åŠ›æµ‹è¯•</label>
              <select id="stress">
                <option value="none">æ— </option>
                <option value="time">æ—¶é—´å‹ç¼©(-30%)</option>
                <option value="noise">æ•°æ®æ±¡æŸ“(5%å™ªå£°)</option>
                <option value="change">éœ€æ±‚å˜æ›´(æ–°å¢çº¦æŸ)</option>
                <option value="all">ç»¼åˆå‹åŠ›æµ‹è¯•</option>
              </select>
            </div>
          </div>
          <div class="flex">
            <div style="font-size:28px;font-weight:900" id="timer">08:00:00</div>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="startTimer()">å¼€å§‹</button>
            <button class="btn" onclick="pauseTimer()">æš‚åœ</button>
            <button class="btn" onclick="resetTimer()">é‡ç½®</button>
          </div>
        </div>

        <!-- ç­”è¾©æ¨¡æ‹Ÿï¼ˆåŸæ ·ä¿ç•™ï¼‰ -->
        <div class="card">
          <h3>ç­”è¾©æ¨¡æ‹Ÿ</h3>
          <div id="defenseQuestion" style="background:#fff;border:1px solid var(--line);border-radius:8px;padding:10px;margin-bottom:10px;min-height:80px">
            è¯·ç‚¹å‡»"ç”Ÿæˆé—®é¢˜"å¼€å§‹ç­”è¾©æ¨¡æ‹Ÿ...
          </div>
          <textarea id="defenseAnswer" rows="4" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ç­”è¾©å›ç­”..."></textarea>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="generateQuestion()">ç”Ÿæˆé—®é¢˜</button>
            <button class="btn" onclick="submitDefense()">æäº¤å›ç­”</button>
            <button class="btn" onclick="recordVideo()">ğŸ“¹ å½•åˆ¶è§†é¢‘</button>
          </div>
          <div id="defenseResult" style="margin-top:10px;display:none">
            <div class="flex"><b>ç­”è¾©è¯„åˆ†</b><span id="defenseScore" class="defense-score score-excellent">92/100</span></div>
            <pre id="defenseFeedback" style="white-space:pre-wrap;background:#fff;border:1px solid var(--line);border-radius:8px;padding:10px;margin-top:8px;font-size:12px">
ç»´åº¦è¯„ä¼°:
- é€»è¾‘æ€§: 9/10 âœ“ é€»è¾‘æ¸…æ™°,è®ºè¯ä¸¥å¯†
- å‡†ç¡®æ€§: 9/10 âœ“ å›ç­”å‡†ç¡®,æ•°æ®å¯é 
- æµç•…åº¦: 9/10 âœ“ è¡¨è¾¾æµç•…,èŠ‚å¥é€‚ä¸­
- åº”å¯¹èƒ½åŠ›: 8/10 âœ“ å¯¹è¿½é—®ååº”è¿…é€Ÿ

æ”¹è¿›å»ºè®®:
1. å¢åŠ æ›´å¤šå®é™…æ¡ˆä¾‹æ”¯æ’‘
2. ä¼˜åŒ–å¼€åœºç™½,å¸å¼•è¯„å§”æ³¨æ„
3. è‚¢ä½“è¯­è¨€å¯æ›´è‡ªç„¶äº›
</pre>
          </div>
        </div>

        <!-- è¯„åˆ†ä¸å»ºè®®ï¼ˆåŸæ ·ä¿ç•™ï¼‰ -->
        <div class="card" style="grid-column:span 2">
          <h3>ç»¼åˆè¯„åˆ†ä¸å»ºè®®</h3>
          <textarea id="simInput" rows="6" placeholder="ç®€è¦æè¿°ä½ çš„æ–¹æ³•ä¸å®éªŒç»“æœ..."></textarea>
          <div class="grid auto-3" style="margin-top:8px">
            <div class="card"><div class="muted">ç®—æ³•è®¾è®¡</div><div class="kpi" id="scoreAlgo" style="color:#16a34a">---</div></div>
            <div class="card"><div class="muted">å®ç°è´¨é‡</div><div class="kpi" id="scoreImpl" style="color:#2563eb">---</div></div>
            <div class="card"><div class="muted">ç­”è¾©è¡¨ç°</div><div class="kpi" id="scoreDefense" style="color:#a78bfa">---</div></div>
          </div>
          <div id="advice" style="margin-top:12px;padding:10px;background:#fff;border:1px solid var(--line);border-radius:8px">
            æäº¤åç”Ÿæˆé’ˆå¯¹æ€§æ”¹è¿›å»ºè®®ã€‚
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" onclick="evaluate()">æäº¤ç»¼åˆè¯„åˆ†</button>
            <button class="btn" onclick="generateReport()">ğŸ“Š ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ç¤¾åŒº -->
    <section id="community" class="section" style="display:none">
      <div class="grid auto-2">
        <div class="card"><h3>æœ€æ–°é—®ç­”</h3><div id="qaList" class="grid"></div></div>
        <div class="card"><h3>å‘å¸ƒé—®é¢˜</h3>
          <input id="qaTitle" placeholder="å¦‚:LSTM å¯¹é•¿åºåˆ—çš„æ”¹è¿›?"/>
          <textarea id="qaText" rows="6" placeholder="æè¿°ä½ çš„é—®é¢˜æˆ–ç»™å‡ºæœ€å°å¤ç°..."></textarea>
          <div class="toolbar">
            <button class="btn primary" onclick="postQA()">å‘å¸ƒ(+10ç®—åŠ›)</button>
            <span class="muted">è¯·è„±æ•éå…¬å¼€æ•°æ®ä¸æ¶‰å¯†å†…å®¹</span>
          </div>
        </div>
      </div>
    </section>

    <!-- å¸‚åœºä¸è´¢åŠ¡ -->
    <section id="market" class="section" style="display:none">
      <div class="grid auto-3">
        <div class="card"><h3>è´¢åŠ¡è¶‹åŠ¿(è¥æ”¶/æˆæœ¬/å‡€åˆ©)</h3><div id="c-finance" class="chart" data-chart="finance"></div></div>
        <div class="card"><h3>æ”¶å…¥ç»“æ„</h3><div id="c-rev" class="chart" data-chart="rev"></div></div>
        <div class="card"><h3>æˆæœ¬ç»“æ„</h3><div id="c-cost" class="chart" data-chart="cost"></div></div>
        <div class="card"><h3>TAM / SAM / SOM</h3><div id="c-tam" class="chart" data-chart="tam"></div></div>
        <div class="card"><h3>è·å®¢æ¼æ–—</h3><div id="c-funnel" class="chart" data-chart="funnel"></div></div>
        <div class="card"><h3>ç•™å­˜ Cohort(çƒ­åŠ›)</h3><div id="c-cohort" class="chart" data-chart="cohort"></div></div>
        <div class="card"><h3>ç›ˆäºç€‘å¸ƒ</h3><div id="c-waterfall" class="chart" data-chart="waterfall"></div></div>
        <div class="card"><h3>ç”¨æˆ·å¢é•¿é¢„æµ‹</h3><div id="c-users" class="chart" data-chart="users"></div></div>
        <div class="card"><h3>ç«å“å¯¹æ¯”(é›·è¾¾)</h3><div id="c-radar-competitor" class="chart" data-chart="rc"></div></div>
      </div>
    </section>
  </main>
</div>

<!-- èŠå¤©æŠ½å±‰(çœŸæ­£å¯ç”¨: ç§èŠè”ç³»äºº + æœ¬åœ°æŒä¹… + å¤šæ ‡ç­¾åŒæ­¥) -->
<aside id="chatDrawer" class="drawer" aria-hidden="true">
  <div class="chat-head">
    <strong>å›¢é˜ŸèŠå¤©</strong>
    <span class="muted">(Esc å…³é—­)</span>
    <span class="right"></span>
    <button class="btn" onclick="UI.toggleChat()">å…³é—­</button>
  </div>
  <div class="chat-body">
    <div class="chat-list" id="chatList"></div>
    <div class="message">
      <div id="messageBox" style="display:flex;flex-direction:column;gap:8px;overflow:auto"></div>
    </div>
  </div>
  <div class="chat-input">
    <input id="chatText" placeholder="è¾“å…¥æ¶ˆæ¯,å›è½¦å‘é€"/>
    <button class="btn primary" onclick="ChatUI.send()">å‘é€</button>
  </div>
</aside>

<!-- API è®¾ç½®å¼¹çª— -->
<div id="apiModal" class="auth" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:50">
  <div class="panel" style="background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;width:min(520px,92vw)">
    <div class="flex" style="justify-content:space-between">
      <b style="font-size:18px">API è®¾ç½®</b>
      <button class="btn" onclick="closeAPIModal()">å…³é—­</button>
    </div>
    <label style="margin-top:8px">API Key</label>
    <input id="apiKeyInput" placeholder="ä¾‹å¦‚:sk-xxxx"/>
    <div class="flex" style="justify-content:flex-end;margin-top:10px">
      <button class="btn primary" onclick="saveAPI()">ä¿å­˜</button>
    </div>
    <div class="hint">ä¿å­˜å,ä¾èµ– API çš„åŠŸèƒ½å°†è‡ªåŠ¨è§£é”ã€‚</div>
  </div>
</div>

<script>
// ========== UI:é€šçŸ¥/èŠå¤© ==========
const UI={
  toggleDropdown(id){
    const el=document.getElementById(id);
    el.classList.toggle('open');
    document.addEventListener('click',function once(e){
      if(!el.contains(e.target)){ el.classList.remove('open'); document.removeEventListener('click',once); }
    });
  },
  toggleChat(){
    const d=document.getElementById('chatDrawer');
    d.classList.toggle('open');
    if(d.classList.contains('open')) ChatUI.refresh();
  }
};
window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ document.getElementById('chatDrawer').classList.remove('open'); }});

// ========== å¯¼èˆª ==========
function go(id,btn){
  document.querySelectorAll('main .section').forEach(s=>s.style.display='none');
  const sec=document.getElementById(id); 
  if(sec) {
      sec.style.display='';
      setTimeout(()=>{ ChartManager.initSection(id); },100);
  }
  document.querySelectorAll('aside .nav button').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

// ========== ECharts ç®¡ç† ==========
const ChartManager=(function(){
  const cache=new Map();
  function mount(el, option){
    if(!el) return;
    const oldChart = cache.get(el.id);
    if(oldChart && !oldChart.isDisposed()) oldChart.dispose();
    const chart=echarts.init(el,null,{renderer:'canvas'});
    chart.setOption(option);
    cache.set(el.id, chart);
    setTimeout(()=>chart.resize(),50);
  }
  function line(labels,series){
    return {tooltip:{trigger:'axis'},legend:{bottom:0},grid:{left:40,right:20,top:20,bottom:40},
    xAxis:{type:'category',data:labels},yAxis:{type:'value'},
    series:series.map(s=>({type:'line',name:s.name,data:s.data,smooth:true,areaStyle:{opacity:.15},lineStyle:{color:s.color}}))};
  }
  function pie(data,colors){
    return {tooltip:{trigger:'item'},legend:{bottom:0},
    series:[{type:'pie',radius:['40%','70%'],data,itemStyle:{color:(p)=>colors?colors[p.dataIndex]:null}}]};
  }
  const gens={
    growth(){return line(['M1','M2','M3','M4','M5','M6','M7','M8','M9','M10','M11','M12'],[{name:'DAU',data:[1200,1300,1500,1700,2100,2400,2600,3000,3600,4200,5000,6100],color:'#22c55e'}]);},
    usage(){return pie([{name:'ç»„é˜Ÿ',value:28},{name:'å®¡æŸ¥',value:26},{name:'è®ºæ–‡',value:18},{name:'æ¨¡æ‹Ÿ',value:14},{name:'ç¤¾åŒº',value:9},{name:'å¸‚åœº',value:5}],['#22c55e','#60a5fa','#f59e0b','#a78bfa','#ef4444','#10b981']);},
    radar(){return {legend:{bottom:0},radar:{indicator:[{name:'æ™ºèƒ½ç»„é˜Ÿ',max:100},{name:'ä»£ç å®¡æŸ¥',max:100},{name:'è®ºæ–‡è¾…åŠ©',max:100},{name:'èµ›é¢˜è§£æ',max:100},{name:'ç¤¾åŒº',max:100},{name:'å®æˆ˜æ¨¡æ‹Ÿ',max:100}]},series:[{type:'radar',data:[{name:'æ•°æµ·å¼•èˆª',value:[85,80,78,82,75,74]}]}]};},
    finance(){return {tooltip:{trigger:'axis'},legend:{bottom:0},grid:{left:40,right:20,top:20,bottom:40},xAxis:{type:'category',data:['2025Q1','2025Q2','2025Q3','2025Q4','2026Q1','2026Q2']},yAxis:{type:'value'},series:[{name:'è¥æ”¶',type:'line',smooth:true,areaStyle:{opacity:.12},data:[120,138,160,190,230,260],lineStyle:{color:'#22c55e'}},{name:'æˆæœ¬',type:'line',smooth:true,areaStyle:{opacity:.08},data:[70,76,84,95,110,125],lineStyle:{color:'#ef4444'}},{name:'å‡€åˆ©',type:'bar',data:[50,62,76,95,120,135],itemStyle:{color:'#60a5fa'}}]};},
    rev(){return pie([{name:'SaaSè®¢é˜…',value:55},{name:'ä¼ä¸šæœåŠ¡',value:25},{name:'æ•™è‚²åŸ¹è®­',value:12},{name:'å¢å€¼ä¸å…¶ä»–',value:8}],['#22c55e','#60a5fa','#a78bfa','#f59e0b']);},
    cost(){return pie([{name:'äººåŠ›',value:48},{name:'äº‘èµ„æº',value:22},{name:'å¸‚åœº',value:15},{name:'å…¶ä»–',value:15}],['#ef4444','#10b981','#60a5fa','#94a3b8']);},
    tam(){return {tooltip:{trigger:'axis'},legend:{bottom:0},grid:{left:40,right:20,top:20,bottom:40},xAxis:{type:'category',data:['TAM','SAM','SOM']},yAxis:{type:'value'},series:[{name:'è§„æ¨¡(ç™¾ä¸‡)',type:'bar',data:[1200,320,85],itemStyle:{color:'#a78bfa'}}]};},
    funnel(){return {tooltip:{trigger:'item'},series:[{type:'funnel',left:'5%',width:'90%',label:{show:true,position:'inside'},data:[{value:100,name:'è®¿é—®'},{value:62,name:'æ³¨å†Œ'},{value:38,name:'æ¿€æ´»'},{value:21,name:'ä»˜è´¹'},{value:12,name:'ç•™å­˜'}]}]};},
    cohort(){const weeks=['W1','W2','W3','W4','W5','W6','W7','W8'];const cohorts=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ'];const data=[];for(let i=0;i<cohorts.length;i++){for(let j=0;j<weeks.length;j++){const base=90-i*8-j*5; data.push([j,i,Math.max(5,Math.min(95,base))]);}}return {tooltip:{position:'top'},grid:{left:60,right:20,top:20,bottom:40},xAxis:{type:'category',data:weeks,splitArea:{show:true}},yAxis:{type:'category',data:cohorts,splitArea:{show:true}},visualMap:{min:0,max:100,calculable:false,orient:'horizontal',left:'center',bottom:0},series:[{type:'heatmap',data,dataLabels:false}]};},
    waterfall(){const items=[{name:'èµ·å§‹',val:200},{name:'è¥æ”¶',val:+120},{name:'æˆæœ¬',val:-70},{name:'è¥é”€',val:-25},{name:'å…¶ä»–',val:-10},{name:'æœŸæœ«',val:0}];const cats=items.map(i=>i.name);const data=items.map(i=>i.val);const acc=[];let sum=0;for(let i=0;i<data.length;i++){if(i===0){acc.push(0); sum=data[i]; continue;}acc.push(Math.max(0,sum));sum+=data[i];}const real=data.map((v,i)=>{if(i===0) return 0;if(i===data.length-1) return sum;return Math.abs(v);});const colors=(p)=> (p.dataIndex===0||p.dataIndex===data.length-1)?'#60a5fa':(data[p.dataIndex]>=0?'#22c55e':'#ef4444');return {tooltip:{trigger:'axis'},xAxis:{type:'category',data:cats},yAxis:{type:'value'},series:[{type:'bar',stack:'t',itemStyle:{borderColor:'transparent',color:'transparent'},data:acc},{type:'bar',stack:'t',data:real,itemStyle:{color:colors},label:{show:true,position:'top',formatter:(p)=>{if(p.dataIndex===0) return items[0].val;if(p.dataIndex===items.length-1) return sum;return (data[p.dataIndex]>0?'+':'')+data[p.dataIndex];}}}]};},
    users(){return line(['2025Q3','2025Q4','2026Q1','2026Q2','2026Q3','2026Q4','2027Q1','2027Q2','2027Q3','2027Q4'],[{name:'ç”¨æˆ·æ•°',data:[2000,5000,9000,14000,20000,30000,45000,65000,85000,100000],color:'#22c55e'}]);},
    rc(){return {legend:{bottom:0},radar:{indicator:[{name:'æ™ºèƒ½ç»„é˜Ÿ',max:100},{name:'ä»£ç å®¡æŸ¥',max:100},{name:'è®ºæ–‡è¾…åŠ©',max:100},{name:'èµ›é¢˜è§£æ',max:100},{name:'ç¤¾åŒº',max:100},{name:'å®æˆ˜æ¨¡æ‹Ÿ',max:100}]},series:[{type:'radar',data:[{name:'æ•°æµ·å¼•èˆª',value:[85,80,78,82,75,74]},{name:'ç«å“A',value:[70,65,60,62,55,50]}]}]};},
    inputstruct(){
      const nodes=['é¢˜ç›®','å®ä½“','çº¦æŸ','ç›®æ ‡','æ•°æ®','æ¨¡å‹','è¯„æµ‹'].map(name=>({name}));
      const links=[
        {source:'é¢˜ç›®',target:'å®ä½“',value:6},
        {source:'é¢˜ç›®',target:'çº¦æŸ',value:5},
        {source:'é¢˜ç›®',target:'ç›®æ ‡',value:4},
        {source:'å®ä½“',target:'æ•°æ®',value:5},
        {source:'æ•°æ®',target:'æ¨¡å‹',value:4},
        {source:'çº¦æŸ',target:'æ¨¡å‹',value:3},
        {source:'ç›®æ ‡',target:'è¯„æµ‹',value:4},
        {source:'æ¨¡å‹',target:'è¯„æµ‹',value:5}
      ];
      return {
        tooltip:{trigger:'item'},
        series:[{type:'sankey',left:10,right:10,top:10,bottom:20,
        data:nodes,links,emphasis:{focus:'adjacency'},
        lineStyle:{color:'gradient',curveness:0.5},
        label:{color:'#0f172a'} }]
      };
    }
  };
  return {
    init(){
      document.querySelectorAll('.chart[data-chart]').forEach(el=>{
        if(el.offsetParent!==null && el.offsetWidth > 0){
          const key=el.getAttribute('data-chart');
          if(gens[key]) mount(el, gens[key]());
        }
      });
      window.addEventListener('resize',()=>{ 
        cache.forEach(ch=>{ if(ch && !ch.isDisposed()) ch.resize(); }); 
      });
    },
    initSection(sectionId){
      const section=document.getElementById(sectionId);
      if(!section) return;
      section.querySelectorAll('.chart[data-chart]').forEach(el=>{
        const key=el.getAttribute('data-chart'); if(!gens[key]) return;
        mount(el, gens[key]());
      });
    },
    exportPNG(id){
      const ch=echarts.getInstanceByDom(document.getElementById(id));
      if(!ch) return;
      const url=ch.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#ffffff'});
      const a=document.createElement('a'); a.href=url; a.download=id+'.png'; a.click();
    }
  };
})();

// ========== æ™ºèƒ½ç»„é˜Ÿ ==========
let mySkills=[70,75,60,55,65,50];
function cosine(a,b){const dot=a.reduce((s,v,i)=>s+v*b[i],0);const na=Math.sqrt(a.reduce((s,v)=>s+v*v,0));const nb=Math.sqrt(b.reduce((s,v)=>s+v*v,0));return dot/(na*nb);}
const mockAPI={
  teammates:(()=>{const names=["å¼ æ€æº","çšå®‰è‡»","æœ±æ€¡æ™¨","äºæ–‡æ˜Š","ä¸ç»å®‡","çºªå®¶å¯Œ","æä½³æ˜","å®‹ä¸‡é‡Œ","æ—ä¸€","å‘¨äºŒ","ç‹äº”","èµµå…­"];
    return names.map((n,i)=>({id:i+1,name:n,skills:[R(40,95),R(40,95),R(40,95),R(40,95),R(40,95),R(40,95)],tags:P(["ç®—æ³•","Python","Java","LaTeX","å¯è§†åŒ–","çº¿ä»£","æ¦‚ç‡","è¿ç­¹"],3)}));
    function R(a,b){return Math.floor(Math.random()*(b-a+1))+a}
    function P(pool,k){return [...pool].sort(()=>Math.random()-0.5).slice(0,k)}
  })(),
  qaSeed:[
    {id:1,title:"LSTM é•¿åºåˆ—å¦‚ä½•ç¨³ä½æ¢¯åº¦?",text:"æ³¨æ„åŠ› or Transformer æ˜¯å¦æ›´ä¼˜?",votes:12,bounty:30},
    {id:2,title:"MCM è®ºæ–‡å›¾è¡¨è§„èŒƒæ¸…å•",text:"å­—å·/é…è‰²/ç¼–å·/å¼•ç”¨ç»Ÿä¸€è§„åˆ™?",votes:9,bounty:20},
    {id:3,title:"å……ç”µæ¡©é€‰å€æ¨¡å‹çº¦æŸ",text:"å®¹é‡ã€è¦†ç›–ã€é¢„ç®—ã€äº¤é€šç½‘ç»œä¸å…¬å¹³æ€§çº¦æŸå¦‚ä½•å†™?",votes:15,bounty:50}
  ]
};

function matchTeammates(){
  const w=[1,1,1,1.2,1,1.2], me=mySkills.map((v,i)=>v*w[i]);
  const res=mockAPI.teammates.map(t=>{
    const tv=t.skills.map((v,i)=>v*w[i]);
    const sim=cosine(me,tv);
    const comp=(Math.abs(me[3]-tv[3])+Math.abs(me[5]-tv[5]))/200;
    return {...t,score: +(sim*0.8 + comp*0.2).toFixed(3)};
  }).sort((a,b)=>b.score-a.score).slice(0,6);

  const list=document.getElementById('matchList'); list.innerHTML='';
  res.forEach(t=>{
    list.insertAdjacentHTML('beforeend',`
<div class="match">
  <div class="flex">
    <span class="avatar">${t.name.slice(-1)}</span>
    <b>${t.name}</b>
    <span class="right chip">åŒ¹é… ${Math.round(t.score*100)}%</span>
  </div>
  <div class="muted" style="font-size:12px;margin:6px 0;">æŠ€èƒ½:${t.skills.map(v=>v.toString().padStart(2,' ')).join(' / ')}</div>
  <div class="grid" style="grid-template-columns:repeat(3,auto);gap:6px;margin-top:4px;">
    ${t.tags.map(x=>`<span class="chip">${x}</span>`).join('')}
  </div>
  <div class="toolbar" style="margin-top:6px">
    <button class="btn" onclick="Contacts.add(${t.id},'${t.name.replace(/'/g,"\\'")}')">åŠ å…¥é€šè®¯å½•</button>
    <button class="btn primary" onclick="ChatUI.openWith(${t.id},'${t.name.replace(/'/g,"\\'")}')">ç§èŠ</button>
  </div>
</div>`);
  });
}

// å®æ—¶æ›´æ–°é›·è¾¾
document.querySelectorAll('.skill').forEach(sl=>{
  sl.addEventListener('input',e=>{
    const i=+e.target.dataset.i; mySkills[i]=+e.target.value;
    const el=document.getElementById('chart-radar'); const chart=echarts.getInstanceByDom(el);
    if(chart && !chart.isDisposed()){ chart.setOption({series:[{data:[{name:'æˆ‘',value:mySkills}]}]},{merge:'mixin'}); }
  });
});

// ========== ä»£ç å®¡æŸ¥ ==========
function runReview(){
  if(!API.key){ tipNeedAPI(); return; }
  const code=document.getElementById('code').value;
  const out=document.getElementById('reviewOut');
  const findings=[];
  if(/for\s*\(\s*int\s+i=0;.*for\s*\(\s*int\s+j=i\+1/im.test(code) || /for .*:\s*for/im.test(code)){
    findings.push('æ—¶é—´å¤æ‚åº¦å¯èƒ½ä¸º O(n^2),å¯ç”¨å“ˆå¸Œè¡¨é™è‡³ O(n)ã€‚');
  }
  if(code.length<10) findings.push('ä»£ç ä¸ºç©ºæˆ–è¿‡çŸ­,è¯·ç²˜è´´çœŸå®ç‰‡æ®µã€‚');
  const fix=`# Python ç¤ºä¾‹:O(n) è§£
def two_sum(nums, target):
    mp={}
    for i,x in enumerate(nums):
        if target-x in mp: return [mp[target-x], i]
        mp[x]=i
    return []`;
  out.innerHTML = `
  <div class="chip" style="background:#e8f0fe;border-color:#c7d2fe;color:#1e3a8a;">å‘ç° ${findings.length} é¡¹é—®é¢˜</div>
  <ul>${findings.map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul>
  <div style="margin-top:8px"><b>ä¿®å¤å»ºè®®</b></div>
  <pre style="white-space:pre-wrap;background:#fff;border:1px solid var(--line);padding:8px;border-radius:8px;">${escapeHTML(fix)}</pre>`;
}
function insertSnippet(){
  document.getElementById('code').value = `def two_sum(nums, target):
    for i in range(len(nums)):
        for j in range(i+1, len(nums)):
            if nums[i] + nums[j] == target:
                return [i, j]
    return []`;
}

// ========== èµ›é¢˜è§£æ - å¢å¼ºç‰ˆ ==========
function analyzeRAG(){
  if(!API.key){ tipNeedAPI(); return; }
  const raw=document.getElementById('ragInput').value.trim();
  const out=document.getElementById('ragOut');
  if(!raw){ out.textContent='è¯·å…ˆç²˜è´´èµ›é¢˜æè¿°ã€‚'; return; }

  // ç®€å•å®ä½“/çº¦æŸ/ç›®æ ‡æå–
  const ents=[...new Set((raw.match(/[\u4e00-\u9fa5A-Za-z0-9]{2,}/g)||[]))].slice(0,10);
  const constraints = [];
  if(/æ—¶é—´|è€—æ—¶|ç§’|åˆ†é’Ÿ/.test(raw)) constraints.push('æ—¶é—´é™åˆ¶');
  if(/å†…å­˜|ç©ºé—´|GB|MB/.test(raw)) constraints.push('å†…å­˜é™åˆ¶');
  if(/ç²¾åº¦|è¯¯å·®|å‡†ç¡®ç‡/.test(raw)) constraints.push('ç²¾åº¦è¦æ±‚');
  if(/å¹¶è¡Œ|å¤šçº¿ç¨‹|åˆ†å¸ƒå¼/.test(raw)) constraints.push('å¹¶è¡Œè¦æ±‚');
  const objectives = [];
  if(/æœ€å°|æœ€å°‘|æœ€ä½/.test(raw)) objectives.push('æœ€å°åŒ–ç›®æ ‡');
  if(/æœ€å¤§|æœ€å¤š|æœ€é«˜/.test(raw)) objectives.push('æœ€å¤§åŒ–ç›®æ ‡');
  if(/ä¼˜åŒ–|æ”¹è¿›|æå‡/.test(raw)) objectives.push('ä¼˜åŒ–ç›®æ ‡');
  const suggestions = [];
  if(/å›¾|ç½‘ç»œ|èŠ‚ç‚¹|è¾¹/.test(raw)) suggestions.push('è€ƒè™‘å›¾è®ºç®—æ³•(å¦‚æœ€çŸ­è·¯å¾„ã€æœ€å°ç”Ÿæˆæ ‘)');
  if(/æ’åº|æŸ¥æ‰¾|æœç´¢/.test(raw)) suggestions.push('è€ƒè™‘é«˜æ•ˆçš„æ’åºæˆ–æœç´¢ç®—æ³•');
  if(/åŠ¨æ€è§„åˆ’|DP|çŠ¶æ€è½¬ç§»/.test(raw)) suggestions.push('è€ƒè™‘åŠ¨æ€è§„åˆ’æ–¹æ³•');
  if(/æœºå™¨å­¦ä¹ |ç¥ç»ç½‘ç»œ|è®­ç»ƒ/.test(raw)) suggestions.push('è€ƒè™‘æœºå™¨å­¦ä¹ æˆ–æ·±åº¦å­¦ä¹ æ¨¡å‹');

  out.innerHTML = `
  <div><b>èµ›é¢˜è§£æç»“æœ</b></div>
  <div style="margin-top:10px">
    <div class="chip" style="background:#e8f0fe;margin-right:8px">å®ä½“è¯†åˆ«</div>
    ${ents.map(x=>`<span class="chip">${escapeHTML(x)}</span>`).join('')}
  </div>
  <div style="margin-top:10px">
    <div class="chip" style="background:#e8f0fe;margin-right:8px">çº¦æŸæ¡ä»¶</div>
    ${constraints.map(x=>`<span class="chip">${x}</span>`).join('')}
  </div>
  <div style="margin-top:10px">
    <div class="chip" style="background:#e8f0fe;margin-right:8px">ç›®æ ‡å‡½æ•°</div>
    ${objectives.map(x=>`<span class="chip">${x}</span>`).join('')}
  </div>
  <div style="margin-top:10px">
    <div class="chip" style="background:#e8f0fe;margin-right:8px">è§£é¢˜æ€è·¯å»ºè®®</div>
    <ul style="margin-top:5px;padding-left:20px">${suggestions.map(x=>`<li>${x}</li>`).join('')}</ul>
  </div>
  <div class="muted" style="margin-top:10px">å·²æ ¹æ®è¾“å…¥æ›´æ–°å¯è§†ç»“æ„å›¾ã€‚</div>`;

  const el=document.getElementById('c-input-structure'); 
  const ch=echarts.getInstanceByDom(el);
  if(ch && !ch.isDisposed()){ 
    const nodes = ['é¢˜ç›®', ...ents.slice(0,5), 'æ¨¡å‹', 'è¯„æµ‹'];
    const links = [
      {source:'é¢˜ç›®', target:ents[0]||'å®ä½“1', value:5},
      {source:'é¢˜ç›®', target:ents[1]||'å®ä½“2', value:4},
      {source:'é¢˜ç›®', target:ents[2]||'å®ä½“3', value:3},
      {source:ents[0]||'å®ä½“1', target:'æ¨¡å‹', value:4},
      {source:ents[1]||'å®ä½“2', target:'æ¨¡å‹', value:3},
      {source:'æ¨¡å‹', target:'è¯„æµ‹', value:6}
    ];
    ch.setOption({ series:[{ data: nodes.map(name=>({name})), links }] }, true);
  }
}

// ========== çœŸé¢˜å¢™é›†æˆ ==========
const zhenURLByMode={
  home:'https://zhentiqiang.com/',
  math:'https://zhentiqiang.com/?tab=math',
  english:'https://zhentiqiang.com/?tab=english',
  cs:'https://zhentiqiang.com/?tab=cs'
};
document.getElementById('zhenMode').addEventListener('change',e=>{
  const url=zhenURLByMode[e.target.value]||zhenURLByMode.home;
  document.getElementById('zhenFrame').src=url;
});
function openZhentiInNew(){
  const sel=document.getElementById('zhenMode').value;
  const url=zhenURLByMode[sel]||zhenURLByMode.home;
  window.open(url,'_blank','noopener');
}

// ========== è®¡æ—¶å™¨/ç­”è¾©/è¯„åˆ† ==========
let timerId=null; let isPaused=false; let leftSec=8*3600;
function updateTimerDisplay() {
  const hours = parseInt(document.getElementById('timeInput').value) || 8;
  leftSec = hours * 3600;
  document.getElementById('timer').textContent = fmt(leftSec);
}
function fmt(sec){ 
  const h=String(Math.floor(sec/3600)).padStart(2,'0'); 
  const m=String(Math.floor(sec%3600/60)).padStart(2,'0'); 
  const s=String(sec%60).padStart(2,'0'); 
  return `${h}:${m}:${s}`; 
}
function startTimer(){
  if(timerId) clearInterval(timerId);
  const stress=document.getElementById('stress').value;
  const hours = parseInt(document.getElementById('timeInput').value) || 8;
  leftSec = hours * 3600;
  if(stress==='time') leftSec=Math.floor(leftSec*0.7);
  if(stress==='all') leftSec=Math.floor(leftSec*0.6);
  isPaused=false;
  timerId=setInterval(()=>{ 
    if(!isPaused) {
      leftSec=Math.max(0,leftSec-1); 
      document.getElementById('timer').textContent=fmt(leftSec); 
      if(leftSec===0) { clearInterval(timerId); alert('æ—¶é—´åˆ°!è¯·æäº¤ä½ çš„ç­”æ¡ˆã€‚'); }
    }
  },1000);
}
function pauseTimer(){ isPaused = !isPaused; }
function resetTimer(){ clearInterval(timerId); timerId=null; isPaused=false; updateTimerDisplay(); }

const defenseQuestions = [
  "è¯·ç®€è¦è¯´æ˜ä½ çš„ç®—æ³•è®¾è®¡æ€è·¯å’Œæ ¸å¿ƒåˆ›æ–°ç‚¹ã€‚","ä½ çš„æ–¹æ³•åœ¨æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦ä¸Šæœ‰ä»€ä¹ˆä¼˜åŠ¿?","ä¸ç°æœ‰æ–¹æ³•ç›¸æ¯”,ä½ çš„æ–¹æ¡ˆè§£å†³äº†å“ªäº›å…³é”®é—®é¢˜?",
  "åœ¨å®éªŒä¸­é‡åˆ°çš„æœ€å¤§æŒ‘æˆ˜æ˜¯ä»€ä¹ˆ?ä½ æ˜¯å¦‚ä½•è§£å†³çš„?","ä½ çš„æ–¹æ³•æœ‰å“ªäº›å±€é™æ€§?æœªæ¥å¦‚ä½•æ”¹è¿›?","è¯·è§£é‡Šä¸€ä¸‹ä½ çš„æ¨¡å‹ä¸­çš„å…³é”®å‚æ•°è®¾ç½®åŠå…¶å½±å“ã€‚",
  "å¦‚ä½•éªŒè¯ä½ çš„å®éªŒç»“æœçš„æœ‰æ•ˆæ€§å’Œå¯é æ€§?","ä½ çš„ç ”ç©¶å¯¹å®é™…åº”ç”¨æœ‰ä»€ä¹ˆä»·å€¼?","å¦‚æœæ•°æ®è§„æ¨¡æ‰©å¤§10å€,ä½ çš„æ–¹æ³•è¿˜èƒ½ä¿æŒæ€§èƒ½å—?","è¯·è¯´æ˜ä½ çš„ä»£ç æ¶æ„å’Œæ¨¡å—è®¾è®¡æ€è·¯ã€‚"
];
function generateQuestion(){
  const box = document.getElementById('defenseQuestion');
  const idx = Math.floor(Math.random() * defenseQuestions.length);
  box.innerHTML = `<b>ç­”è¾©é—®é¢˜:</b> ${defenseQuestions[idx]}`;
  document.getElementById('defenseAnswer').value = '';
  document.getElementById('defenseResult').style.display = 'none';
}
function submitDefense(){
  const answer = document.getElementById('defenseAnswer').value.trim();
  if(!answer){ alert('è¯·å…ˆè¾“å…¥ç­”è¾©å›ç­”!'); return; }
  const logicScore = 8 + Math.floor(Math.random() * 3);
  const accuracyScore = 7 + Math.floor(Math.random() * 4);
  const fluencyScore = 8 + Math.floor(Math.random() * 3);
  const responseScore = 7 + Math.floor(Math.random() * 4);
  const totalScore = logicScore + accuracyScore + fluencyScore + responseScore;
  const percentage = Math.round((totalScore / 40) * 100);
  let scoreClass = 'score-poor';
  if(percentage >= 90) scoreClass = 'score-excellent';
  else if(percentage >= 80) scoreClass = 'score-good';
  else if(percentage >= 70) scoreClass = 'score-fair';
  document.getElementById('defenseScore').textContent = `${percentage}/100`;
  document.getElementById('defenseScore').className = `defense-score ${scoreClass}`;
  const feedback = `ç»´åº¦è¯„ä¼°:
- é€»è¾‘æ€§: ${logicScore}/10 ${logicScore>=9?'âœ“ é€»è¾‘æ¸…æ™°,è®ºè¯ä¸¥å¯†':logicScore>=7?'é€»è¾‘åŸºæœ¬æ¸…æ™°':'éœ€è¦åŠ å¼ºé€»è¾‘æ€§'}
- å‡†ç¡®æ€§: ${accuracyScore}/10 ${accuracyScore>=9?'âœ“ å›ç­”å‡†ç¡®,æ•°æ®å¯é ':accuracyScore>=7?'å›ç­”åŸºæœ¬å‡†ç¡®':'éœ€è¦æé«˜å‡†ç¡®æ€§'}
- æµç•…åº¦: ${fluencyScore}/10 ${fluencyScore>=9?'âœ“ è¡¨è¾¾æµç•…,èŠ‚å¥é€‚ä¸­':fluencyScore>=7?'è¡¨è¾¾åŸºæœ¬æµç•…':'éœ€è¦æé«˜è¡¨è¾¾æµç•…åº¦'}
- åº”å¯¹èƒ½åŠ›: ${responseScore}/10 ${responseScore>=9?'âœ“ å¯¹è¿½é—®ååº”è¿…é€Ÿ':responseScore>=7?'åº”å¯¹èƒ½åŠ›å°šå¯':'éœ€è¦åŠ å¼ºåº”å˜èƒ½åŠ›'}

æ”¹è¿›å»ºè®®:
1. å¢åŠ æ›´å¤šå®é™…æ¡ˆä¾‹æ”¯æ’‘
2. ä¼˜åŒ–å¼€åœºç™½,å¸å¼•è¯„å§”æ³¨æ„
3. è‚¢ä½“è¯­è¨€å¯æ›´è‡ªç„¶äº›
4. å‡†å¤‡æ›´å¤šæ•°æ®æ”¯æ’‘ä½ çš„è®ºç‚¹`;
  document.getElementById('defenseFeedback').textContent = feedback;
  document.getElementById('defenseResult').style.display = 'block';
}
function recordVideo(){
  alert('è§†é¢‘å½•åˆ¶åŠŸèƒ½éœ€è¦æµè§ˆå™¨æƒé™ã€‚è¯·å…è®¸ä½¿ç”¨æ‘„åƒå¤´å’Œéº¦å…‹é£ã€‚\n\næç¤º:åœ¨å®é™…ç¯å¢ƒä¸­,è¿™é‡Œä¼šè°ƒç”¨æµè§ˆå™¨çš„MediaRecorder APIè¿›è¡Œå½•åˆ¶ã€‚');
}
function evaluate(){
  const txt=document.getElementById('simInput').value.trim();
  const stress=document.getElementById('stress').value;
  if(!txt){ alert('è¯·å…ˆæè¿°ä½ çš„æ–¹æ³•ä¸å®éªŒç»“æœ!'); return; }
  let algoScore = 70;
  if(/åˆ›æ–°|æ–°é¢–/.test(txt)) algoScore+=10;
  if(/é«˜æ•ˆ|ä¼˜åŒ–/.test(txt)) algoScore+=8;
  if(/å¤æ‚åº¦|O\(/.test(txt)) algoScore+=5;
  let implScore = 75;
  if(/é²æ£’|å¥å£®/.test(txt)) implScore+=8;
  if(/æµ‹è¯•|éªŒè¯/.test(txt)) implScore+=7;
  if(/ä»£ç |å®ç°/.test(txt)) implScore+=5;
  let defenseScore = 80;
  if(/æ¸…æ™°|æ˜ç¡®/.test(txt)) defenseScore+=8;
  if(/é€»è¾‘|è®ºè¯/.test(txt)) defenseScore+=7;
  if(/æ•°æ®|ç»“æœ/.test(txt)) defenseScore+=5;
  if(stress==='noise') { algoScore-=3; implScore-=5; }
  if(stress==='change') { algoScore-=5; implScore-=3; defenseScore-=2; }
  if(stress==='all') { algoScore-=8; implScore-=8; defenseScore-=5; }
  algoScore=Math.max(0,Math.min(100,algoScore));
  implScore=Math.max(0,Math.min(100,implScore));
  defenseScore=Math.max(0,Math.min(100,defenseScore));
  const totalScore = Math.round((algoScore + implScore + defenseScore) / 3);
  document.getElementById('scoreAlgo').textContent = algoScore;
  document.getElementById('scoreAlgo').style.color = getScoreColor(algoScore);
  document.getElementById('scoreImpl').textContent = implScore;
  document.getElementById('scoreImpl').style.color = getScoreColor(implScore);
  document.getElementById('scoreDefense').textContent = defenseScore;
  document.getElementById('scoreDefense').style.color = getScoreColor(defenseScore);
  const adviceText = `ç»¼åˆè¯„åˆ†: ${totalScore}/100

è¯¦ç»†åˆ†æ:
1. ç®—æ³•è®¾è®¡ (${algoScore}/100): ${algoScore>=80?'è®¾è®¡åˆç†,è€ƒè™‘å…¨é¢':algoScore>=60?'åŸºæœ¬æ»¡è¶³è¦æ±‚,æœ‰æ”¹è¿›ç©ºé—´':'éœ€è¦é‡æ–°å®¡è§†ç®—æ³•è®¾è®¡'}
2. å®ç°è´¨é‡ (${implScore}/100): ${implScore>=80?'ä»£ç è§„èŒƒ,å®ç°å®Œæ•´':implScore>=60?'å®ç°åŸºæœ¬æ­£ç¡®,ä½†å¯ä¼˜åŒ–':'éœ€è¦åŠ å¼ºä»£ç å®ç°å’Œæµ‹è¯•'}
3. ç­”è¾©è¡¨ç° (${defenseScore}/100): ${defenseScore>=80?'è¡¨è¾¾æ¸…æ™°,åº”å¯¹è‡ªå¦‚':defenseScore>=60?'è¡¨è¾¾åŸºæœ¬æ¸…æ¥š':'éœ€è¦åŠ å¼ºè¡¨è¾¾å’Œæ²Ÿé€šèƒ½åŠ›'}

ä¼˜åŒ–å»ºè®®:
${generateAdvice(algoScore, implScore, defenseScore, stress)}`;
  document.getElementById('advice').textContent = adviceText;
}
function getScoreColor(score){ if(score>=90) return '#22c55e'; if(score>=80) return '#2563eb'; if(score>=70) return '#f59e0b'; return '#ef4444'; }
function generateAdvice(algoScore, implScore, defenseScore, stress){
  let advice=[];
  if(algoScore < 80){ advice.push('â€¢ æ·±å…¥åˆ†æé—®é¢˜æœ¬è´¨,è€ƒè™‘æ›´å¤šè¾¹ç•Œæƒ…å†µ'); advice.push('â€¢ ç ”ç©¶ç›¸å…³æ–‡çŒ®,å€Ÿé‰´å…ˆè¿›ç®—æ³•æ€æƒ³'); advice.push('â€¢ è¿›è¡Œæ›´å……åˆ†çš„å¤æ‚åº¦åˆ†æ'); }
  if(implScore < 80){ advice.push('â€¢ åŠ å¼ºä»£ç æµ‹è¯•,åŒ…æ‹¬å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•'); advice.push('â€¢ ä¼˜åŒ–ä»£ç ç»“æ„,æé«˜å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§'); advice.push('â€¢ è€ƒè™‘æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†'); }
  if(defenseScore < 80){ advice.push('â€¢ æå‰å‡†å¤‡ç­”è¾©å†…å®¹,è¿›è¡Œå¤šæ¬¡æ¨¡æ‹Ÿæ¼”ç»ƒ'); advice.push('â€¢ å­¦ä¹ æœ‰æ•ˆçš„è¡¨è¾¾æŠ€å·§å’Œè‚¢ä½“è¯­è¨€'); advice.push('â€¢ å‡†å¤‡åº”å¯¹è¯„å§”å¯èƒ½æå‡ºçš„é—®é¢˜'); }
  if(stress !== 'none'){ advice.push('â€¢ åŠ å¼ºåœ¨å‹åŠ›ç¯å¢ƒä¸‹çš„åº”å˜èƒ½åŠ›è®­ç»ƒ'); advice.push('â€¢ å»ºç«‹å›¢é˜Ÿåä½œæœºåˆ¶,æé«˜æ²Ÿé€šæ•ˆç‡'); advice.push('â€¢ åˆ¶å®šåº”æ€¥é¢„æ¡ˆ,åº”å¯¹çªå‘çŠ¶å†µ'); }
  return advice.join('\n');
}
function generateReport(){
  alert('æ­£åœ¨ç”Ÿæˆè¯¦ç»†è¯„ä¼°æŠ¥å‘Š...\n\nåœ¨å®é™…ç¯å¢ƒä¸­,è¿™é‡Œä¼šç”ŸæˆPDFæ ¼å¼çš„è¯¦ç»†æŠ¥å‘Š,åŒ…æ‹¬:\n1. å„é¡¹ç»´åº¦è¯„åˆ†è¯¦æƒ…\n2. æ”¹è¿›å»ºè®®æ¸…å•\n3. ä¸å…¶ä»–å‚èµ›è€…çš„å¯¹æ¯”åˆ†æ\n4. ä¸ªæ€§åŒ–å­¦ä¹ è·¯çº¿å›¾');
}

// ========== å·¥å…·/è®¤è¯ ==========
function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
const $=id=>document.getElementById(id);
const API={ key: localStorage.getItem('apiKey')||'' };
const Auth={
  users: JSON.parse(localStorage.getItem('users')||'{}'),
  token: localStorage.getItem('token')||'',
  login(u,p,remember){
    const ok = (this.users[u] && this.users[u].pass===p) || (u==='demo@example.com'&&p==='123456');
    if(!ok) return {ok:false,msg:'è´¦å·æˆ–å¯†ç é”™è¯¯'};
    const token='tk_'+Date.now();
    if(remember) localStorage.setItem('token',token);
    sessionStorage.setItem('token',token);
    sessionStorage.setItem('who',u);
    const api = (this.users[u]&&this.users[u].apiKey)||'';
    if(api){ localStorage.setItem('apiKey',api); API.key=api; }
    return {ok:true,token};
  },
  register(name,mail,pass,apiKey){
    if(!/^\S+@\S+\.\S+$/.test(mail)) return {ok:false,msg:'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'};
    if(pass.length<6 || !/[a-zA-Z]/.test(pass) || !/\d/.test(pass)) return {ok:false,msg:'å¯†ç éœ€å«å­—æ¯ä¸æ•°å­—ä¸”ä¸å°‘äº 6 ä½'};
    if(this.users[mail]) return {ok:false,msg:'è¯¥é‚®ç®±å·²æ³¨å†Œ'};
    this.users[mail]={name,pass,apiKey:apiKey||''};
    localStorage.setItem('users',JSON.stringify(this.users));
    return {ok:true};
  },
  logout(){ sessionStorage.removeItem('token'); sessionStorage.removeItem('who'); }
};
const AuthUI={
  switchTab(which){
    const isLogin=which==='login';
    $('tabLogin').classList.toggle('active',isLogin);
    $('tabRegister').classList.toggle('active',!isLogin);
    $('loginForm').style.display = isLogin?'':'none';
    $('registerForm').style.display = isLogin?'none':'';
  }
};
function authLogin(){
  const u=$('loginUser').value.trim();
  const p=$('loginPass').value.trim();
  const remember=$('remember').checked;
  const apiIn=$('loginAPI').value.trim();
  const r=Auth.login(u,p,remember);
  if(!r.ok){ alert(r.msg); return; }
  if(apiIn){ localStorage.setItem('apiKey',apiIn); API.key=apiIn; }
  afterLogin(u);
}
function authRegister(){
  const name=$('regName').value.trim();
  const mail=$('regMail').value.trim();
  const pass=$('regPass').value.trim();
  const api=$('regAPI').value.trim();
  const r=Auth.register(name,mail,pass,api);
  if(!r.ok){ alert(r.msg); return; }
  alert('æ³¨å†ŒæˆåŠŸ,è¯·ç™»å½•ã€‚' + (api?'':'\næç¤º:ä½ å°šæœªé…ç½® API,å¯ç¨ååœ¨ã€ŒAPI è®¾ç½®ã€æˆ–ç™»å½•é¡µè¡¥å……ã€‚'));
  AuthUI.switchTab('login');
  if(api){ localStorage.setItem('apiKey',api); API.key=api; }
}
function afterLogin(who){
  $('who').textContent=who;
  $('auth').style.display='none';
  $('app').style.visibility='visible';
  updateTimerDisplay();
  setTimeout(()=>{ ChartManager.init(); },200);
  renderQA();
  checkAPI();
  go('overview', document.querySelector('aside .nav button[data-go="overview"]'));
}
function logout(){ Auth.logout(); location.reload(); }
function openAPIModal(){ $('apiKeyInput').value = API.key || ''; $('apiModal').style.display='flex'; }
function closeAPIModal(){ $('apiModal').style.display='none'; }
function saveAPI(){ const k=$('apiKeyInput').value.trim(); localStorage.setItem('apiKey',k); API.key=k; closeAPIModal(); checkAPI(); }
function tipNeedAPI(){ alert('è¯¥åŠŸèƒ½ä¾èµ–å¤–éƒ¨ API,è¯·å…ˆåœ¨å·¦ä¾§ã€ŒAPI è®¾ç½®ã€æˆ–ç™»å½•é¡µé…ç½® API Keyã€‚'); }
function checkAPI(){ document.querySelectorAll('[data-requires-api="true"]').forEach(el=>{ el.classList.toggle('requires-mask', !API.key); }); }

// ========== ç¤¾åŒº ==========
function renderQA(){
  const box=document.getElementById('qaList'); box.innerHTML='';
  mockAPI.qaSeed.forEach(q=>{
    box.insertAdjacentHTML('beforeend',`
<div class="card">
  <div class="flex"><b>${escapeHTML(q.title)}</b><span class="right chip">èµé‡‘ ${q.bounty}</span></div>
  <div class="muted">${escapeHTML(q.text)}</div>
  <div class="flex" style="margin-top:6px;">
    <span class="chip">ç¥¨æ•° ${q.votes}</span>
    <span class="chip">#é—®ç­”</span>
  </div>
</div>`);
  });
}
function postQA(){
  const t=$('qaTitle').value.trim();
  const x=$('qaText').value.trim();
  if(!t||!x) return;
  mockAPI.qaSeed.unshift({id:Date.now(),title:t,text:x,votes:0,bounty:10});
  $('qaTitle').value=''; $('qaText').value='';
  renderQA();
}

// ========== é€šè®¯å½•ä¸ç§èŠ(çœŸæ­£å¯ç”¨: æœ¬åœ°æŒä¹… + BroadcastChannel å¤šæ ‡ç­¾åŒæ­¥) ==========
const Contacts={
  key(){ const me=sessionStorage.getItem('who')||'guest'; return `contacts_${me}`; },
  list(){ try{ return JSON.parse(localStorage.getItem(this.key())||'[]'); }catch{return []} },
  save(arr){ localStorage.setItem(this.key(), JSON.stringify(arr)); ChatUI.refreshList(); },
  add(id,name){
    const arr=this.list();
    if(!arr.some(c=>c.id===id)) arr.push({id,name});
    this.save(arr);
    // æç¤ºå¹¶å¯ç›´æ¥èŠå¤©
    ChatUI.openWith(id,name);
  }
};

const Chat={
  channel: new BroadcastChannel('sh-chat'),
  keyFor(userId){ const me=sessionStorage.getItem('who')||'guest'; return `chat_${me}_${userId}`; },
  load(userId){ try{ return JSON.parse(localStorage.getItem(this.keyFor(userId))||'[]'); }catch{return []} },
  save(userId, msgs){ localStorage.setItem(this.keyFor(userId), JSON.stringify(msgs)); },
  send(userId,text){
    const me=sessionStorage.getItem('who')||'guest';
    const msgs=this.load(userId);
    const msg={from:me,to:userId,text,ts:Date.now()};
    msgs.push(msg); this.save(userId,msgs);
    this.channel.postMessage({type:'msg',userId,from:me,text,ts:msg.ts});
  }
};
// æ¥æ”¶å…¶å®ƒæ ‡ç­¾çš„æ¶ˆæ¯å¹¶åˆ·æ–°UI
Chat.channel.onmessage=(ev)=>{
  const data=ev.data||{};
  if(data.type==='msg'){
    if(ChatUI.current && (ChatUI.current.id===data.userId || data.from===ChatUI.current.id)){
      ChatUI.renderMessages(ChatUI.current.id);
    }
  }else if(data.type==='contacts'){
    ChatUI.refreshList();
  }
};

const ChatUI={
  current:null,
  refs(){ return { list: $('chatList'), box: $('messageBox'), input: $('chatText') }; },
  refresh(){ this.refreshList(); if(this.current) this.renderMessages(this.current.id); },
  refreshList(){
    const {list}=this.refs();
    const contacts=Contacts.list();
    list.innerHTML='';
    if(contacts.length===0){ list.innerHTML='<div class="muted" style="padding:6px">æš‚æ— è”ç³»äºº</div>'; return; }
    contacts.forEach(c=>{
      const active=this.current&&this.current.id===c.id;
      const el=document.createElement('div');
      el.className='contact'+(active?' active':'');
      el.innerHTML=`<span class="avatar">${c.name.slice(-1)}</span><span class="ct-name">${c.name}</span>`;
      el.onclick=()=>this.openWith(c.id,c.name);
      list.appendChild(el);
    });
  },
  openWith(id,name){
    const contacts=Contacts.list();
    if(!contacts.some(c=>c.id===id)){ Contacts.add(id,name); Chat.channel.postMessage({type:'contacts'}); }
    this.current={id,name};
    UI.toggleChat(); // æ‰“å¼€æŠ½å±‰
    this.refresh();
  },
  renderMessages(userId){
    const {box}=this.refs(); box.innerHTML='';
    const msgs=Chat.load(userId);
    msgs.forEach(m=>{
      const div=document.createElement('div');
      div.className='msg '+(m.from===(sessionStorage.getItem('who')||'guest')?'me':'you');
      const t=new Date(m.ts); const time=`${t.getHours().toString().padStart(2,'0')}:${t.getMinutes().toString().padStart(2,'0')}`;
      div.innerHTML=`<div style="font-size:12px;color:#64748b;margin-bottom:2px">${time}</div><div>${escapeHTML(m.text)}</div>`;
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  },
  send(){
    const {input}=this.refs();
    const text=input.value.trim();
    if(!text) return;
    if(!this.current){ alert('è¯·é€‰æ‹©è”ç³»äºº'); return; }
    Chat.send(this.current.id,text);
    input.value='';
    this.renderMessages(this.current.id);
  }
};
$('chatText').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); ChatUI.send(); }});

// ========== é¡µé¢åŠ è½½ ==========
window.addEventListener('DOMContentLoaded', () => {
  const token = sessionStorage.getItem('token') || localStorage.getItem('token');
  const who = sessionStorage.getItem('who');
  if(token && who) { afterLogin(who); }
});

// ========== API/ç™»å½•ååˆå§‹åŒ– ==========
function checkContactsBroadcast(){ Chat.channel.postMessage({type:'contacts'}); }
</script>
</body>
</html>